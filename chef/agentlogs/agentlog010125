2025-10-07: Restored Firebase bucket uploads for audio/photo/video in telegram_bot.py; removed GridFS usage so conversation references public firebase URLs.
2025-10-07: Added instruction reminding assistant to acknowledge multimedia without auto-analyzing so users can request analysis explicitly.
2025-10-07: Added testscripts/test_openai_vision.py to probe GPT-4.1-mini vision against Firebase-hosted photo.
2025-10-07: Corrected message_router to load utilities instructions and replace blank system prompt so OpenAI payload carries full base instructions.
2025-10-07: Simplified message_router to load manual instruction path list and reuse combined prompt before optional tool calls.
2025-10-07: Reworked message_router load_instructions to return combined text from manual path list with no fallback prompts.
2025-10-07: Updated instructions_base.txt to enforce acknowledgement-only responses unless user explicitly requests help.
2025-10-07: Forced message_router to overwrite first system message with combined instructions each turn to avoid stale prompts.
2025-10-07: Reverted system-message overwrite; router now only fills when missing or blank.
2025-10-07: Clarified instructions_base to treat descriptive updates as info-only unless user explicitly asks for help.
2025-10-07: Strengthened instructions to keep replies empathetic-only when users express uncertainty without explicit requests.
2025-10-09: Added positive/negative example conversation section to instructions_base.txt to clarify acknowledgement-only vs help-request responses.
2025-10-09: Updated message_router to persist base system instructions after empty-history sessions so /restart reloads the prompt; verified by simulating a fresh conversation.
2025-10-10: Added testscripts/fetch_latest_conversation.py to pull latest Mongo chat snapshot and verified recent user report via CLI helper.
2025-10-10: Added testscripts/test_mongo_media_metadata.py to verify media_metadata inserts in MongoDB.
2025-10-10: Updated testscripts/test_mongo_media_metadata.py to add sys.path injection for chefmain imports.
2025-10-10: Added MongoDB timeout query params in testscripts/test_mongo_media_metadata.py to avoid long hangs.
2025-10-10: Added SIGALRM timeout guard in testscripts/test_mongo_media_metadata.py to fail fast if create_media_metadata hangs.
2026-01-02: Added media_metadata embedding pass in build_chat_session_chunks.py to store ai/user descriptions with media_id and URL, and exposed media fields in answer_with_nano vector results.
2026-01-02: Switched build_chat_session_chunks.py to sentence-level chunking into chat_session_sentence_chunks collection (one sentence per turn, fallback to whole turn).
2026-01-02: Commented out legacy multi-turn chunking at end of build_chat_session_chunks.py for reference only.
2026-01-02: Removed turn_window/turn_overlap args/constants from build_chat_session_chunks.py now that sentence chunking is used.
2026-01-02: Added embedding batch support in build_chat_session_chunks.py to reduce API calls (embedding-batch-size).
2026-01-02: Pointed simple_database_approach/mongo_worker_embedding.py to chat_session_sentence_chunks for vector search.
- 2026-02-23T20:37:58Z: Restored explicit per-turn mode persistence in history; /restart now always triggers media backfill; added migration handoff requirements to AGENTS.md.
- 2026-02-23T22:21:25Z: Incident fix in progress for production bot: restored media-analysis behavior in instructions_base, made create_media_metadata async to reduce turn latency, and prevented stream abort when Telegram status message times out.
- 2026-02-23T22:26:18Z: Added fail-fast photo pipeline handling with TELEGRAM_MEDIA_TIMEOUT_SEC and fallback marker when Telegram get_file/download times out.
- 2026-02-23T22:53:23Z: Fixed media backfill robustness by adding ai_description fallback for user_description, avoiding early return on first no_candidate/no_choice, and allowing vision listener stderr/stdout into Cloud Run logs for diagnosis.
- 2026-02-23T23:00:09Z: Pushed hotfix commit 2d4a84e to origin/main; GitHub Actions run 22328384790 deployed chef-bot revision chef-bot-00017-heb at 100% traffic; deleted extra Cloud Run services chefdev and chevdev so only chef-bot remains.
- 2026-02-23T23:01:32Z: Deploy run 22328523313 failed during Docker base image pull (docker.io python:3.11-slim 504). Triggering fresh push-based redeploy with no functional code change.
- 2026-02-23T23:09:45Z: Added hard asyncio.wait_for timeout wrappers to Telegram photo get_file/download_to_drive in telegram_bot.py to prevent indefinite media pipeline hangs before streaming.
- 2026-02-23T23:10:36Z: On photo pipeline failure, bot now returns immediate user-facing retry error and exits cleanly without routing broken media marker through model.
- 2026-02-23T23:19:34Z: Regression triage now compares main/dev bot webhooks first; found main bot webhook healthy and dev bot webhook returning 404. Added this protocol to chef/AGENTS.md and chef/chefmain/AGENTS.md.
- 2026-02-23T23:19:34Z: Root cause analysis for image regressions: instruction drift in instructions_general changed image reply style; Cloud Run background media subprocesses were unreliable under default CPU throttling. Added --no-cpu-throttling to deploy workflow.
- 2026-02-23T23:19:34Z: Hardened telegram_bot media error path so photo failures return a user-facing retry message without propagating unhandled reply exceptions.
- 2026-02-23T23:21:51Z: Updated media ingest path per user requirement: create_media_metadata now defers description enrichment during active conversation turns; restart-time background backfill remains the trigger for enrichment.
- 2026-02-23T23:26:29Z: Deployed commit 3988200 to chef-bot revision chef-bot-00022-wiv (100% traffic). Verified image turns log metadata with ingest_enrichment=deferred_to_restart, and /restart triggers background backfill that populated ai_description + user_description for latest media docs.
- 2026-02-23T23:28:11Z: Updated photo flow so Firebase storage failure surfaces immediate user-facing error and skips model routing with broken local-path markers.
- 2026-02-23T23:48:14Z: Reverted photo behavior to prior model-driven canned media acknowledgement style by restoring instructions_base/general from origin/dev; restored on-ingest background vision spawn in mongo_media create_media_metadata (still non-blocking via firebase metadata thread).
- 2026-02-23T23:59:10Z: Found behavioral mismatch from Mongo history: user 1275063227 now in chat_general produced 'Cool pic. What's this?'; old desired behavior in prior chat logs used canned non-analysis photo acknowledgement. Updated instructions_general + instructions_base to enforce canned media acknowledgement style and keep analysis only on explicit request.
